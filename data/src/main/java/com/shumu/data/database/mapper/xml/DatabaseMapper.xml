<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.shumu.data.database.mapper.DatabaseMapper">
    <!-- fieldDataType -->
    <sql id="fieldDataType">
        <choose>
            <when test="field.fieldType==0">
                DOUBLE(#{field.fieldLength},#{field.decimalDigits})
            </when>
            <when test="field.fieldType==1">
                INT(#{field.fieldLength})
            </when>
            <when test="field.fieldType==2">
                DECIMAL(#{field.fieldLength},#{field.decimalDigits})
            </when>
            <when test="field.fieldType==3">
                VARCHAR(#{field.fieldLength})
            </when>
            <when test="field.fieldTypee==4">
                TINYINT UNSIGNED
            </when>
            <when test="field.fieldType==5">
                DATETIME
            </when>
            <when test="field.fieldType==6">
                DATE
            </when>
            <when test="field.fieldType==7">
                TIME
            </when>
            <when test="field.fieldTypee==8">
                BOLB
            </when>
            <when test="field.fieldType==9">
                TEXT
            </when>
            <otherwise/>
        </choose>
    </sql>
    <!-- createTableByInfo -->
    <update id="createTableByInfo" parameterType="TableModel" databaseId="mysql">
        <bind name="name" value="tableName"/>
        <if test="databaseName!=null and databaseName!=''">
            <bind name="name" value="databaseName+'.'+tableName"/>
        </if>
        <bind name="comment" value="''"/>
        <if test="tableComment!=null and tableComment!=''">
            <bind name="comment" value="'COMMENT = \''+tableComment+'\''"/>
        </if>
        <bind name="primaryKey" value="''"/>
        CREATE TABLE ${name} (
        <foreach item="field" collection="fieldList">
            <if test="field.status!=3">
            ${field.fieldName}
            <include refid="fieldDataType">
                <property name="field.fieldType" value="field.fieldType"/>
                <property name="field.fieldLength" value="field.fieldLength"/>
                <property name="field.decimalDigits" value="field.decimalDigits"/>
            </include>
            <if test="field.isNullable==0">
                NOT NULL
            </if>
            <if test="field.isNullable==1">
                NULL
            </if>
            <if test="field.isPrimaryKey==1">
                <bind name="primaryKey" value="'PRIMARY KEY ('+field.fieldName+') USING BTREE'"/>
                <if test="primaryKeyType==1">
                    AUTO_INCREMENT
                </if>
            </if>
            <if test="field.defaultValue!=null and field.defaultValue!=''">
                DEFAULT ${field.defaultValue}
            </if>
            <if test="field.fieldComment!=null and field.fieldComment!=''">
                COMMENT '${field.fieldComment}'
            </if>
            ,
            </if>
        </foreach>    
        ${primaryKey}
        <foreach item="item" collection="indexList">
            <if test="item.indexType==1 and item.status!=2">
                ,UNIQUE INDEX ${item.indexName}(${item.indexField}) USING BTREE
            </if>
            <if test="item.indexType!=1 and item.status!=2">
                ,INDEX ${item.indexName}(${indexField}) USING BTREE
            </if>
        </foreach>
        )
        ${comment};
    </update>
    <!-- createTableByReferenced -->
    <update id="createTableByReferenced" parameterType="TableModel" databaseId="mysql">
        CREATE TABLE ${tableName}( 
        SELECT
        <foreach item="field" collection="fieldList" separator=",">
            <if test="field.status!=3">
            <if test="field.referencedTable!=null and field.referencedTable!=''">${field.referencedField}.</if>${field.referencedField} AS ${field.fieldName}
            </if> 
        </foreach>
        ${referencedSql}
    </update>
    <!-- createTableView -->
    <update id="createTableView" parameterType="TableModel" databaseId="mysql">
        CREATE VIEW ${tableName} AS
        SELECT
        <foreach item="field" collection="fieldList" separator=",">
            <if test="field.status!=3">
            <if test="field.referencedTable!=null and field.referencedTable!=''">${field.referencedField}.</if>${field.referencedField} AS ${field.fieldName}
            </if> 
        </foreach>
        ${referencedSql}
    </update>
    <!-- changeTable -->
    <update id="changeTable" parameterType="TableModel" databaseId="mysql">
        <bind name="addField" value=""/>
        <bind name="changeField" value=""/>
        <bind name="dropField" value=""/>
        <bind name="after" value=""/>
        <foreach item="field" collection="fieldList">
            <if test="field.status==1 or field.status==2">
                <bind name="fieldType" value=""/>
                <choose>
                    <when test="field.fieldType==0">
                        <bind name="fieldType" value="'DOUBLE('+field.fieldLength+','+decimalDigits+') '"/>
                    </when>
                    <when test="field.fieldType==1">
                        <bind name="fieldType" value="'INT('+field.fieldLength+') '"/>
                    </when>
                    <when test="field.fieldType==2">
                        <bind name="fieldType" value="'DECIMAL('+field.fieldLength+','+decimalDigits+') '"/>
                    </when>
                    <when test="field.fieldType==3">
                        <bind name="fieldType" value="'VARCHAR('+field.fieldLength+') '"/>
                    </when>
                    <when test="field.fieldType==4">
                        <bind name="fieldType" value="'TINYINT UNSIGNED '"/>
                    </when>
                    <when test="field.fieldType==5">
                        <bind name="fieldType" value="'DATETIME '"/>
                    </when>
                    <when test="field.fieldType==6">
                        <bind name="fieldType" value="'DATE '"/>
                    </when>
                    <when test="field.fieldType==7">
                        <bind name="fieldType" value="'TIME '"/>
                    </when>
                    <when test="field.fieldType==8">
                        <bind name="fieldType" value="'BOLB '"/>
                    </when>
                    <when test="field.fieldType==9">
                        <bind name="fieldType" value="'TEXT '"/>
                    </when>
                    <otherwise/>
                </choose>
                <bind name="nullable" value="'NULL '"/>
                <if test="field.isNullable==0">
                    <bind name="nullable" value="'NOT NULL '"/>
                </if>
                <bind name="fieldDefault" value="''"/>
                <if test="field.defaultValue!=null and field.defaultValue!=''">
                    <bind name="fieldDefault" value="'DEFAULT '+field.defaultValue+' '"/>
                </if>
                <bind name="fieldComment" value="''"/>
                <if test="field.fieldComment!=null and field.fieldComment!=''">
                    <bind name="fieldComment" value="'COMMENT \''+field.fieldComment+'\''"/>
                </if>
                <if test="field.status==1">
                    <bind name="changeField" value="changeField+'CHANGE COLUMN '+field.oldName+' '+field.fieldName+' '+fieldType+nullable+fieldDefault+fieldComment+' AFTER '+after+','"/>
                </if>
                <if test="field.status==2">
                    <bind name="addField" value="addField+'ADD COLUMN '+field.fieldName+' '+fieldType+nullable+fieldDefault+fieldComment+' AFTER '+after+','"/>
                </if>
            </if>
            <if test="field.status==3">
                <bind name="dropField" value="dropField+'DROP COLUMN '+field.fieldName+','"/>
            </if>
            <bind name="after" value="field.fieldName"/>
        </foreach>
        ALTER TABLE ${oldName}
        ${dropField}
        ${addField}
        ${changeField}
        <foreach item="index" collection="indexList">
            <if test="item.status==2 or item.status==3">
                DROP INDEX '${index.oldName}',
            </if>
            <if test="item.status!=1">
                ADD <if test="item.indexType!=1">UNIQUE</if> INDEX ${item.indexName}(${item.indexField}) USING BTREE,
            </if>
            <if test="item.status==2">
                ADD INDEX ${item.indexName}(${item.indexField}) USING BTREE,
            </if>
        </foreach>
        <if test="tableName==oldName">
         RENAME TO ${tableName},
        </if>
         COMMENT = '${tableComment}';
    </update>
    <!-- getDbTableInfo -->
    <select id="getDbTableInfo" parameterType="string" resultType="DataTableInfo" databaseId="mysql"> 
      SELECT
        TABLE_SCHEMA schema_name,
        TABLE_NAME table_name, IF(TABLE_TYPE='VIEW',3,1) table_type,
        TABLE_COMMENT table_comment,
        ISNULL(AUTO_INCREMENT) id_type
      FROM
        information_schema.tables
        <where>
            <if test="database!=null and database!=''">
           TABLE_SCHEMA = ${databaseName} AND
            </if>
            <if test="table!=null and table!=''">
           TABLE_NAME = ${table}
            </if>
        </where>
    </select>
    <!-- getDbTableFields -->
    <select id="getDbTableFields" parameterType="string" resultType="DataTableField" databaseId="mysql"> 
      SELECT
        COLUMN_NAME field_name,
        COLUMN_COMMENT field_comment,
        IF(IS_NULLABLE,1,0) is_nullable,
        COLUMN_DEFAULT default_value, IF(COLUMN_KEY='PRI',1,0) is_primary_key,
        (
           CASE DATA_TYPE
           WHEN 'double' THEN 0  
           WHEN 'int' THEN 1 
           WHEN 'decimal' THEN 2
           WHEN 'varchar' THEN 3
           WHEN 'tinyint' THEN 4
           WHEN 'datetime' THEN 5 
           WHEN 'date' THEN 6
           WHEN 'time' THEN 7
           WHEN 'bolb' THEN 8
           WHEN 'text' THEN 9
           WHEN 'mediumtext' THEN 10
           WHEN 'longtext' THEN 11
           ELSE 12 END
         ) field_type,
         IFNULL(CHARACTER_MAXIMUM_LENGTH,NUMERIC_PRECISION) field_length,
         NUMERIC_SCALE decimal_digits,
         ORDINAL_POSITION field_order
      FROM
        information_schema.columns
        <where>
            <if test="database!=null and database!=''">
           TABLE_SCHEMA = ${database} AND
            </if>
            <if test="table!=null and table!=''">
           TABLE_NAME = ${table}
            </if>
        </where>
    </select>
    <!-- getDbTableIndexes -->
    <select id="getDbTableIndexes" parameterType="string" resultType="DataTableIndex" databaseId="mysql"> 
      SELECT
        INDEX_NAME index_name,
        COLUMN_NAME index_field,
        NON_UNIQUE index_type,
        SEQ_IN_INDEX index_num
      FROM
        information_schema.statistics
        <where>
            <if test="database!=null and database!=''">
           TABLE_SCHEMA = ${database} AND
            </if>
            <if test="table!=null and table!=''">
           TABLE_NAME = ${table} AND
            </if>
           INDEX_NAME != 'PRIMARY'
        </where>
    </select>
    <!-- dropDbTable -->
    <update id="dropDbTable" parameterType="string">
       DROP TABLE IF EXISTS 
        <if test="database!=null and database!=''">${database}.</if>${table}
    </update>
    <update id="dropDbView" parameterType="string">
       DROP VIEW IF EXISTS 
        <if test="database!=null and database!=''">${database}.</if>${table}
    </update>
    <resultMap id="TableResult" type="TableModel">
        <id property="id" column="id" />
        <collection property="fieldList" column="id" ofType="DataTableField" select="getFields"/>
        <collection property="indexList" column="id" ofType="DataTableField" select="getIndexes"/>
    </resultMap>
    <!--获取创建表格所需信息-->
    <select id="getTableModel" parameterType="string" resultMap="TableResult" databaseId="mysql">
      SELECT * FROM data_table_info WHERE id = #{tableId}
    </select>
    <select id="getFields" parameterType="string" resultType="DataTableField" databaseId="mysql">
      SELECT * FROM data_table_field WHERE table_id = #{tableId} ORDER BY field_order
    </select>
    <select id="getIndexes" parameterType="string" resultType="DataTableIndex">
      SELECT * FROM data_table_index WHERE table_id = #{tableId} ORDER BY index_num
    </select>
    <update  id="updateTableStatus" parameterType="string" databaseId="mysql">
       UPDATE data_table_info SET status = 1, old_name = #{name} WHERE id = #{id};
    </update>
    <update  id="dropIndex" parameterType="string" databaseId="mysql">
       UPDATE data_table_field SET status = 1 WHERE table_id = #{id};
    </update>
    <!-- getDatabaseNames -->
    <select id="getDatabaseNames" resultType="string" databaseId="mysql">
      SELECT schema_name FROM information_schema.schemata WHERE schema_name != 'mysql' AND schema_name != 'information_schema' AND schema_name != 'performance_schema'
    </select>
    <!-- getDatabaseNames -->
    <select id="getDatabaseNames" resultType="string" databaseId="oracle">
      SELECT USERNAME FROM ALL_USERS ORDER BY USERNAME
    </select>
</mapper>